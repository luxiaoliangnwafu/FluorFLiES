c      Parameters Initialization
c**********************************************

      subroutine iparam (
     &     flg,cflg,rtype,atype,nkd,
     &     wl0,wls,nwl,span,
     &     taur,ctaur,d,
     &     th0,ph0,tm,hfov,
     &     tflx,bflx,dflx,obflx,odflx,
     &     tpfd,bpfd,dpfd,obpfd,odpfd,
     &     rflx,rbflx,rdflx,scmpf,scmpp,
     &     cbnz,ctnz,RF,RQ,
     &     fpc,fpf,fpv,ext,Nid
     &  )

      implicit none
      include 'common.inc'
      include 'math.inc'

      integer i,j,k,l,Nid

      integer ix(1024),frndi

!     return to main program
      integer flg,cflg,rtype,atype,nkd,nwl
      integer cbnz,ctnz
      real wl0,wls,span(1000)
      real taur,ctaur,d
      real th0,ph0,tm,hfov

      real*8 tflx,bflx,dflx,obflx,odflx
      real*8 tpfd,bpfd,dpfd,obpfd,odpfd
      real*8 rflx, rbflx, rdflx
      real*8 scmpf(3,1000),scmpp(3,1000)

      real RF,RQ
      real fpc,fpf,fpv(100)

      integer knmix,knang,knzext
      parameter (knmix=10, knang=2000, knzext=200)
      real ext(knmix, knzext)

      Data (ix(i),i=1,1024)/ 715327539,474399417,182768403,
     & 780769431,576730197,937392842,445151859,688527083,160158012,
     & 750394380,704034435,445074075,668471240,896236437,567474752,
     & 686366724,313996988,336207690,785978227,778020274,918287307,
     & 165417294,345438969,907890635,347416159,564662778,423338472,
     & 322334997,537865632,861550217,847868806,131114898,991933631,
     & 711366790,789845275,154507895,445727944,529958587,952987849,
     & 941223627,914187765,387129643,731071531,106928367,428804814,
     & 339530062,987977910,349373608,666589081,249856479,762473708,
     & 492770269,984295237,762602078,309875385,181659605,554070627,
     & 544579014,145075585,518001246,574235904,470872688,375689646,
     & 919288736,793184089,576772630,583573585,630078959,718095433,
     & 922435718,260494938,899714994,845035588,550636380,614489316,
     & 129748380,342385542,752870810,561946344,901663726,773463362,
     & 291476356,142718061,857835626,599125462,822165143,148115470,
     & 102699640,719609755,114280930,315919730,632002210,662364387,
     & 475737383,521125644,473855143,713211613,581004834,124188662,
     & 385785588,212828838,395410802,861018067,166374165,861383384,
     & 600531530,232779699,631097769,686852794,999512106,415913715,
     & 881422436,984974586,539663088,857359588,472863933,448952791,
     & 946881961,785362821,238347978,227637797,822765690,738837653,
     & 262806318,959824693,686128383,326913756,243790771,282925300,
     & 347129324,483847659,666342264,911506146,217384530,323057584,
     & 898291599,182956265,233336405,245978702,227818927,221598428,
     & 509776547,447233226,214040942,414571726,517627480,507070145,
     & 293723551,952738082,125537664,628467971,608408802,524136102,
     & 279781483,918029707,548632100,640354341,235301552,938506978,
     & 780259168,659470605,956230694,325113028,469281736,218069674,
     & 669464838,897083532,428805136,686481469,360384586,358491134,
     & 472625645,958973413,731986004,450382757,828050124,528788635,
     & 516020488,711633133,549766916,820648300,744078099,756772887,
     & 181891301,327751624,988430935,213427722,866142696,964985638,
     & 496034786,735881912,572488659,743238997,879294425,713844186,
     & 767544317,516990455,924970513,495397278,293978777,835805356,
     & 387324693,959867930,279599267,563193517,901016831,583683180,
     & 467890018,888909125,290367062,825984930,897427982,667439448,
     & 193090536,669374716,796016824,842227637,893353706,100791099,
     & 874773830,225275495,700911164,505312681,384159177,495752993,
     & 185093925,754601478,990426230,540048843,117183163,284735697,
     & 654715317,720082843,589553463,999204993,292192117,956943678,
     & 520778593,787604343,475951343,238244029,738028538,450868237,
     & 882337337,852777892,714244800,845837140,319648818,163957206,
     & 158674488,640909075,952790546,799179255,480213829,353940284,
     & 619044995,555360287,428642246,562991225,297469578,458329311,
     & 272641456,355631524,310239267,815292841,100535538,449940916,
     & 726618528,110184604,638394987,845519244,222809445,274570728,
     & 777646374,989143276,722952055,386900100,173563846,259192337,
     & 804837858,150796596,944107592,241958057,536792668,172954717,
     & 245518931,765096962,292466963,598520195,342293274,742080068,
     & 732690459,332958489,487763014,331451785,453715831,304306945,
     & 670086896,387259837,228740735,573510956,726406580,433203637,
     & 671245718,170436887,221798990,328530055,528306588,384406611,
     & 432767805,562542760,704605746,837753498,786313664,629190021,
     & 191473640,666614669,755747532,379664975,702568554,695219945,
     & 570526945,565430802,113455511,729851019,708613234,846314841,
     & 461649617,449048089,973078024,396699738,389404076,724621301,
     & 591522955,566275215,346788763,514627617,805478692,874203109,
     & 984912198,859577828,624179011,987852382,776539105,645075726,
     & 205693244,235354499,950277531,601152193,119875329,678681015,
     & 703088581,926062923,501421090,737043684,835391223,339952000,
     & 736254954,626308470,726111215,589620465,246772944,575693416,
     & 244674022,664175254,804692804,492974600,502179351,105707521,
     & 912971061,712505763,772011214,409435805,514390751,434718710,
     & 568864083,693147993,108412769,717491453,163571384,748691016,
     & 193417558,103828531,244246532,738387846,294243296,629307234,
     & 450758266,322059829,351363754,160164791,367319893,587539178,
     & 447192484,850313907,566630554,149750910,831939166,588153833,
     & 151727745,870573383,992379736,351560574,619998413,357348138,
     & 398057472,510176438,798292303,778476464,269448219,235280376,
     & 546121954,946146821,171925198,713047999,751387333,145542333,
     & 540686538,213339531,646850329,254061029,567989629,101491674,
     & 511445713,976020085,765062844,854291462,126419931,320127592,
     & 726073664,501840615,784555584,416186872,298616638,204913941,
     & 530023872,333112770,711398977,421232482,105471433,698953098,
     & 718673020,211273633,639423400,481902280,834338939,337258231,
     & 174255883,958625638,597575950,439795354,988194686,725370764,
     & 288606071,652712941,172317773,325139743,940627425,492783117,
     & 544820171,488717451,606341838,582640069,792202669,592277354,
     & 302321077,258376838,831743204,792493635,310322348,249334776,
     & 769693785,506666097,202308101,126671762,852585899,243781933,
     & 212450419,658941084,781093174,142874742,976827108,774326443,
     & 954241406,423692041,437779057,549959793,687359732,584795171,
     & 687710458,396150502,210256204,749684453,794749748,148324950,
     & 497469338,535762405,520967233,329461720,307514692,695794153,
     & 976011556,567257386,908122807,379152056,132028931,968366134,
     & 158820642,132730855,394504806,284807178,713499200,565936505,
     & 857418435,116150068,922622507,299500587,244074843,634191107,
     & 434319168,498511296,211463896,254241408,509565162,174777144,
     & 619098263,461522963,979462164,194666354,479420781,654949367,
     & 546923801,163301688,194472229,701938289,729811966,704713141,
     & 172904969,337296640,573704075,450154206,821816778,352260041,
     & 542208772,740407979,513786503,360789814,481501424,877278476,
     & 618555653,294747538,852938073,941717422,425875252,316396425,
     & 585554182,501336869,220635233,326374846,482671993,951440107,
     & 742191863,967128026,140806645,884695804,254039706,525141957,
     & 268142265,567372882,102905902,645042306,319375286,843252885,
     & 412742513,558692395,284106625,157423258,815817373,698219943,
     & 309580288,735815125,137278393,790358489,945752859,237983600,
     & 396490848,782421189,500067272,753798800,435267785,335600680,
     & 821875894,309346842,522548636,936234825,363221210,816270077,
     & 582875460,850904583,545167812,463222974,339507237,308870281,
     & 487556564,668586951,768946576,840601950,380444666,970218682,
     & 130818789,979514467,574695205,740414148,875068712,155558241,
     & 950725245,243294508,298463980,521267265,632429379,645401185,
     & 729721897,136967290,199017487,444539350,997838729,839200335,
     & 587381196,880762827,409252047,128474914,763457381,833866065,
     & 703891903,492486625,938723272,988592243,272785383,440529581,
     & 120519592,180093396,280580070,786109495,777856391,936727976,
     & 123705718,169591884,630828422,871188521,159661253,927312511,
     & 555372625,239872492,571394586,245277479,566895931,616924226,
     & 641473895,565217298,578284591,411284571,396620988,226639439,
     & 978504025,722013819,707072252,627414184,728702336,629999244,
     & 236095204,545612818,233551371,128490893,929005736,541735309,
     & 146455038,388578063,701168870,497181886,605335366,593862646,
     & 649999511,700344359,596646457,941726326,131553557,196462468,
     & 728614306,552047276,187689284,466783955,250581520,345926004,
     & 675570994,721695333,538164564,320628093,120164535,848130375,
     & 442103126,742325812,733032494,804702085,865477508,751452833,
     & 299490810,944428598,186884447,739405047,928227144,685114991,
     & 352093368,644984370,794827264,487401399,580778777,538013046,
     & 577440607,531804564,556137967,210654774,909569001,431705918,
     & 649663913,347817739,942342323,686363077,104334047,311862446,
     & 307242770,404658630,444671663,637728619,189879047,492842099,
     & 351035720,497138702,637451654,536757424,474827873,203027128,
     & 282233773,932952767,410118830,789557313,872889310,839059573,
     & 472144806,824421149,713342022,561833637,732224237,326279896,
     & 976913100,614424353,758227449,574671709,377494746,615525883,
     & 927542752,151950633,727296161,154128218,822941052,471023160,
     & 481720185,882544672,442547461,615864646,615197741,573103207,
     & 793041825,521291270,878148531,450254708,830705833,349478349,
     & 832974821,895334196,196964927,245983436,348982274,768813431,
     & 911096143,891245651,180867790,567402976,478034266,628175771,
     & 945884341,229315733,569857144,186785695,165582142,475116720,
     & 707223582,686165130,367357766,253716620,739102226,569993185,
     & 792424112,621876281,606350421,228971847,890372592,244926230,
     & 444357630,404276227,150045567,875459617,892705684,314217399,
     & 397682526,665889990,201763533,671684849,485985970,890571665,
     & 426160129,234326247,737729150,718820112,939559102,128263398,
     & 713078951,537823629,430655351,549691599,975228619,907891225,
     & 505661314,774230527,423441469,467359691,535485547,314569331,
     & 873291748,917821514,231576071,766682898,216533385,431382417,
     & 276676692,243621818,451869961,978292721,966844195,831742131,
     & 747027510,444085198,995860546,728259825,370109578,439736077,
     & 814043951,270593723,233908681,640119379,542656674,618111264,
     & 529876700,421904590,486525496,405207249,814850115,681845700,
     & 548767498,400876072,362372827,531800755,383228987,229728204,
     & 819131296,700170713,172289831,906871557,850126636,864350444,
     & 627107125,450550422,675152140,868928599,211951635,166159857,
     & 337720108,891153866,361899819,642024445,439627662,143827704,
     & 199016615,240285606,443759444,359789028,815392673,564878320,
     & 209565602,388550195,928746581,489589545,230407714,563131290,
     & 518506333,278271935,680408090,512241283,480297219,282204416,
     & 855593729,850283330,630477321,671157473,363739091,857839488,
     & 432136413,724229806,108647099,781859052,169139583,780270111,
     & 773479938,837574487,465207675,747239726,194121423,436023390,
     & 145433472,474004194,421773108,983829176,436824458,275210985,
     & 940699148,166465293,877754408,439134913,850040054,698777306,
     & 410009986,570765233,848371505,693898797,757403367,623156607,
     & 516752839,263076202,703176987,697732532,349000808,699375867,
     & 956577932,462465894,851222318,581388550,957187867,852737927,
     & 399635469,145038761,117024413,636334460,604822957,573563528,
     & 414576151,678724038,665047293,898052990,110377544,318905645,
     & 496241262,498133292,660918354,947286063,582360690,637050825,
     & 704483383,474406659,929325616,747815275,391085982,936901086,
     & 708458739,204045931,692734181,129042436,696603751,869574207,
     & 853373664,836296576,153963825,433753517,322276310,642164617,
     & 700613063,695282870,907520276,246662250,926170587,616911351,
     & 882269155,618787074,538490641,105029377,852397340,770021498,
     & 665877866,276560163,350916147,205514039,416253310,498361334,
     & 854810738,282842473,952407902,452399832,966281896,295668850,
     & 871440219,612405884,906151652,634743267,182620781,631412714,
     & 345198562/

!   ---  global parameters ---
      nz = 12                   ! # of layers
      xmax = 30.0               ! X domain size (m)
      ymax = xmax               ! Y domain size (m)
      res = real(size) / xmax   !     inverse of the spatial resolution
      wrr = 0.1                 ! ideal weight (used for Russian roulette in atm.)


!     branch portion in region 1 (outer canopy) and 2 (internal canopy)
!     1.0 = 100% branch, 0.0: 100% leaf
      bp1 = 0.0
      bp2 = 1.0

!     leaf angle distribution of canopy, branchs, and floor
!     1 = spherical leaf angle distribution
!     2 = planophile
!     3 = erectrophile
      ! move to rpara.f, read from input
      !mc = 2
      !mb = 2
      !mf = 2

!     parameter initializing
      do i = 1, nrdc
         do j = 1, knyr
            do k = 1, knxr
               prdcF(k, j, i) = 0.0d0
               prdcQ(k, j, i) = 0.0d0
            end do
         end do
      end do

      do l = 1, 2
         do i = 1, 700
               brf(l,i) = 0.0
               brfc(l,i) = 0.0
               brfs(l,i) = 0.0
               brff(l,i) = 0.0
         end do
      end do

      do l = 1, 2
         do i = 1, size
            do j = 1, size
               refl(l,i,j) = 0.0
               irefl(l,i,j) = 0
            end do
         end do
      end do

!     fraction of absorbed radiation
      tfpr = 0.0
      cfpr = 0.0
      bfpr = 0.0
      ffpr = 0.0
      sfpr = 0.0

      do i = 1, 3
         do j = 1, 1000
            scmpf(i,j) = 0.0
            scmpp(i,j) = 0.0
         end do
      end do

      do i = 1, size
         do j = 1, size
            do k = 1, 100
               ap(i,j,k) = 0.0
               apd(i,j,k) = 0.0
               apb(i,j,k) = 0.0
            end do
            apf(i,j) = 0.0
            apfd(i,j) = 0.0
            aps(i,j) = 0.0
            ffdir(i,j) = 0.0
            ffdif(i,j) = 0.0
            sfdir(i,j) = 0.0
            sfdif(i,j) = 0.0
         end do
      end do

      do k = 1, 100
         apnp(k) = 0.0
      end do

      do i = 1, 90
         do j = 1, 360
            feye(i, j) = 0.0
            rfeye(i, j) =0.0
         end do
      end do


!   ---  local parameters ---
      wl0 = 0.55                ! Default target wavelength (micron)
      wls = 0.3                 ! Default start point of wavelength integration
      nwl = 75                  ! Default sampling number of the wavelength
      taur = 0.3              ! default AOT (tau at 550nm)
      ctaur = 0.00            ! default COT (tau at 550nm)
      d = 8000.0                ! default scale height (m)
      rtype = 1                 ! default atmospheric and aerosol type
      atype = 2
      nkd = 3                   ! # of subbands for the k-distribution
      th0 = 10.0                ! solar zenith angle in degree
      ph0 = 0.0                 ! solar azimuth angle in degree
      tm = 1.0                  ! atmopsheric transmittance
      hfov = 1.0                ! detector half widt of the field of view
      hfov = hfov * rad
      hfov = cos(hfov)
      cflg = 0                  ! cflg=0 -> cloud-free, cflg=1 -> cloud

      do i = 1, 1200
         if(i .le. 20)then
            !span(i) = 0.02        ! Wavelength span (0.3-0.7 micron)
            span(i) = 0.001
         else
            !span(i) = 0.1         ! Wavelength span (0.7- micron)
            span(i) = 0.001
         end if
      end do

!     Irradiance
      tflx = 0.0                ! Total downward flux at top of canopy
      bflx = 0.0                  ! Beam downward flux at TOC
      dflx = 0.0                  ! Diffuse downward flux at TOC
      obflx = 0.0                 ! Beam downawr flux at TOC (observed)
      odflx = 0.0                 ! Diffuse downward flux at TOC (observed)

!     reflected radiance from canopy
      rflx =0.0                 ! total reflected irradiaice
      rbflx = 0.0               ! beam reflected irradiance
      rdflx = 0.0               ! diffuse reflected irradiance

!     Photon flux density
      tpfd = 0.0                  ! Total downward PFD at top of canopy
      bpfd = 0.0                  ! Beam downward PFD at top of canopy
      dpfd = 0.0                  ! Diffuse downward PDF at top of canopy
      obpfd = 0.0                 ! Beam downawr PFD at TOC (observed)
      odpfd = 0.0                 ! Diffuse downward PFD at TOC (observed)

!     Number of cloud bottom and top layer
      cbnz = 0
      ctnz = 1

!     incident irradiance and photon flux density at TOA or TOC
      RF = 0.0
      RQ = 0.0

!     initialization of random number generator
      flg = frndi(ix(Nid + 1))

!     atmospheric extinction parameters
      do i = 1, knmix
         do j = 1, knzext
            ext(i, j) = 0.0
         end do
      end do

      do i = 1, 100
         fpv(i) = 0.0
      end do

! fpar for canopy and forest floor
      fpc = 0.0
      fpf = 0.0

      ! SIF initliaze, par region [400, 750]
      do i = 1, 351
         Qin(i) = 0.0
         QFin(i) = 0.0
      end do
      WL_SIF_START = 0.64
      WL_SIF_END = 0.85
      WL_PAR_START = 0.4
      WL_PAR_END = 0.75

      do l = 1, 211
         do i = 1, 351
            Qfs(l, i) = 0.0
            Qfs_e(l, i) = 0.0
            Qfs_s(l, i) = 0.0
         end do
      end do

      do l = 1, 211
         ! SIFplace(i,1) means canopy
         ! SIFplace(i,2) means underground
         Qfs_all(l) = 0.0
         F_scat(l) = 0.0
         F_excited(l) = 0.0
         SIFplace(l,1) = 0.0
         SIFplace(l,2) = 0.0
         SIFplace_e(l,1) = 0.0
         SIFplace_e(l,2) = 0.0
         F_leaflit(i) = 0.0
         F_leafshade(i) = 0.0
         SIF_place_sca_num(l,1) = 0
         SIF_place_sca_num(l,2) = 0
      end do

      do i = 1, size
         do j = 1, size
            do k = 1, size_height
               PAR_LEAF(i,j,k) = 0.0
               SIFarea(i,j) = 0.0
               LEAFLIT(i,j,k) = 0
               SIF_760_3D(i, j, k) = 0.0
               SIF_680_3D(i, j, k) = 0.0
               SIF_760_3D_e(i, j, k) = 0.0
               SIF_680_3D_e(i, j, k) = 0.0
               SIF_760_3D_s(i, j, k) = 0.0
               SIF_680_3D_s(i, j, k) = 0.0
               SIF_e_1st(i, j, k) = 0
               SIF_o_pos(i, j, k) = 0
            end do
         end do
      end do

      do l = 1, 100000
         do i = 1, 10
            WAIT_PHOTON(l, i) = 0.0
         end do
      end do
      WP_INDEX = 0

      HC = 1.9864475e-16
      NAVO = 6.0221367e23
      LEAFAREA = 0.1
      running_mode = 0

      PPFD_T = 0.0
      PPFD_G = 0.0
      PPFD_S = 0.0
      PPFD_F = 0.0

      W_T = 0.0
      W_G = 0.0
      W_S = 0.0 
      W_F = 0.0
      WF_T = 0.0
      WF_G = 0.0 
      WF_S = 0.0 
      WF_F = 0.0
      call calFyeild()

      par0 = 0
      par1 = 0
      par2 = 0
      end

      subroutine calFyeild()
      implicit none
      include "common.inc"

      ! work
      real p0, f0, bp, re
      real p0r, pr
      integer par

      p0 = 0.82
      f0 = 0.01
      bp = 0.0035
      re = 0.005

      do par = 1, 3000
         p0r = p0 / (1 + bp * par * (1 - p0 - f0))
         pr = p0r / (1 + re * p0r * par)
         Fyeild(par) = p0r / p0 * (1 - pr) / (1 - p0r)
      !write(*,*) "Fyeild = ", Fyeild(par)
      end do


      end